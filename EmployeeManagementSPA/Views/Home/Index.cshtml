@{
    ViewBag.Title = "A Simple Single Page Application";
}

<div class="container mt-3">
    <div class="row">
        <button class="btn btn-primary m-auto" data-toggle="modal" data-target="#insertModal">Create New</button>
        <span id="displayMessage" class="hide"></span>
        <button class="btn btn-primary m-auto" onclick="getEmployees('Name', 'asc', 1, 5)">Back to list</button>
    </div>
    <div class="row col-sm-12">
        <div class="text-left display-4 m-auto">Employees</div>
        <table id="tblEmployees" class="table table-bordered table-hover text-center mt-3">
            <thead>
                <tr class="table-dark">
                    <td class="font-weight-bold">
                        <button id="sortByName" class="btn btn-block btn-warning">
                            <p class="pr-3 d-inline">Name</p><span class="fa fa-arrow-up pr-1"></span><span class="fa fa-arrow-down"></span>
                        </button>
                        <div class="input-group-append">
                            <input id="txtSearchName" type="text" class="form-control" placeholder="Search" />
                            @*<button id="searchName" class="fa fa-search btn btn-light"></button>*@
                        </div>
                    </td>
                    <td class="font-weight-bold">
                        <button id="sortByEmail" class="btn btn-block btn-warning mr-3">
                            <p class="pr-3 d-inline">Email</p><span class="fa fa-arrow-up pr-1"></span><span class="fa fa-arrow-down"></span>
                        </button>
                        <div class="input-group-append">
                            <input id="txtSearchEmail" type="text" class="form-control" placeholder="Search" />
                            @*<button id="searchEmail" class="fa fa-search btn btn-light"></button>*@
                        </div>
                    </td>
                    <td class="font-weight-bold">
                        <button id="sortBySalary" class="btn btn-block btn-warning mr-3"><p class="pr-3 d-inline">Salary</p><span class="fa fa-arrow-up pr-1"></span><span class="fa fa-arrow-down"></span></button>
                        <div class="input-group-append">
                            <input id="txtSearchSalary" type="text" class="form-control" placeholder="Search" />
                            @*<button id="searchSalary" class="fa fa-search btn btn-light"></button>*@
                        </div>
                    </td>
                    <td colspan="3" class="font-weight-bold">Actions</td>
                </tr>
            </thead>
            <tbody id="tblBody"></tbody>
        </table>
        <div class="row clearfix">
            <div class="form-group d-block">
                <label for="numberOfRows">Enter the number of rows per page</label>
                <input type="number" value="5" id="numberOfRows" class="form-control" />
            </div>
        </div>
        <ul id="paginationUl" class="pagination justify-content-center mx-auto"></ul>
    </div>
</div>
<div id="dialogInsert" title="Success" style="display:none">
    <p class="text-success">Employee created successfully!</p>
</div>
<div id="dialogEdit" title="Success" style="display:none">
    <p class="text-success">Employee updated successfully!</p>
</div>
<div id="dialogDelete" title="Success" style="display:none">
    <p class="text-success">Employee deleted successfully!</p>
</div>
<div id="dialogError" title="Error" style="display:none">
    <p class="text-danger">Something went wrong. Please try again</p>
</div>

@* Modal for showing the details of an employee *@
<div id="employeeDetails" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Employee Details</div>
                <button class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="displayName">Name</label>
                    <input id="displayName" type="text" disabled class="form-control" />
                </div>
                <div class="form-group">
                    <label for="displayEmail">Email</label>
                    <input id="displayEmail" type="text" disabled class="form-control" />
                </div>
                <div class="form-group">
                    <label for="displaySalary">Salary</label>
                    <input id="displaySalary" type="text" disabled class="form-control" />
                </div>
                <div class="modal-footer">
                    <button class="btn btn-danger" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

@*Modal for creating a new employee*@
<div id="insertModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add New Employee</div>
                <button class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form>
                    <input type="hidden" id="employeeId" />
                    <div class="form-group">
                        <label for="name">Name</label>
                        <input type="text" id="name" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="salary">Salary</label>
                        <input type="text" id="salary" class="form-control" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="btnInsert" class="btn btn-info" data-dismiss="modal">Create</button>
                <button class="btn btn-danger" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

@*modal for editing an existing employee*@
<div id="editModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Edit Item Type</div>
                <button class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form>
                    <input id="editId" type="hidden" />
                    <div class="form-group">
                        <label for="name">Name</label>
                        <input type="text" id="editName" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="editEmail" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="salary">Salary</label>
                        <input type="text" id="editSalary" class="form-control" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="btnEditItem" class="btn btn-info" data-dismiss="modal">Save</button>
                <button class="btn btn-danger" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

@* modal for deleting an employee *@
<div id="deleteModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Are you sure you want to delete this Item Type?</div>
                <button class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form>
                    <input id="deleteId" type="hidden" />
                    <div class="form-group">
                        <label for="name">Name</label>
                        <input type="text" id="deleteName" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="deleteEmail" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="salary">Salary</label>
                        <input type="text" id="deleteSalary" class="form-control" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="btnDeleteItem" class="btn btn-info" data-dismiss="modal">Delete</button>
                <button class="btn btn-danger" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
    //let sortingByWhat = 'name';
    let sortNameDirection = 'asc';
    let pageNumber = 1;
    let rowsPerPage = $('#numberOfRows');
    let sortEmailDirection = 'asc';
    let sortSalaryDirection = 'asc';
    $(document).ready(function () {
        //Declaration of variables
        const searchName = $('#txtSearchName');
        const searchEmail = $('#txtSearchEmail');
        const searchSalary = $('#txtSearchSalary');
        //const table = $('#tblEmployees');
        const dialogInsert = $('#dialogInsert').dialog({ autoOpen: false })
        const dialogEdit = $('#dialogEdit').dialog({ autoOpen: false })
        const dialogDelete = $('#dialogDelete').dialog({ autoOpen: false })
        const dialogError = $('#dialogError').dialog({ autoOpen: false })

        //Call the function getEmployees() which is declared below using hoisting
        getEmployees('Name', 'asc', 1, rowsPerPage.val());
        //Ajax call to create a new employee
        $('#btnInsert').click(function () {
            const Name = $('#name').val();
            const Email = $('#email').val();
            const Salary = $('#salary').val();
            $.ajax({
                url: '/employees',
                method: 'post',
                //Using concise ES6 syntax
                data: { Name, Email, Salary },
                success: function () {
                    getEmployees('Name', 'asc', 1, 5);
                    dialogInsert.dialog('open');
                },
                error: function (error) {
                    console.log(error);
                    dialogError.dialog('open');
                }
            })
        })

        //Ajax call to update the Employee details
        $('#btnEditItem').click(function () {
            const id = $('#editId').val();
            const Name = $('#editName').val();
            const Email = $('#editEmail').val();
            const Salary = $('#editSalary').val();

            $.ajax({
                url: '/employees/' + id,
                method: 'put',
                //Using concise ES6 syntax
                data: { Name, Email, Salary },
                success: function () {
                    getEmployees('Name', 'asc', 1, 5);
                    dialogEdit.dialog('open');
                },
                error: (err) => {
                    console.log(err);
                    $('#dialogError').dialog();
                }
            })
        })

        //Ajax call to delete the Employee
        $('#btnDeleteItem').click(function () {
            const id = $('#deleteId').val();
            $.ajax({
                url: '/employees/' + id,
                method: 'delete',
                success: function () {
                    getEmployees('Name', 'asc', 1, 5);
                    dialogDelete.dialog('open');
                },
                error: (err) => {
                    console.log(err);
                    $('#dialogError').dialog();
                }
            })
        })

        rowsPerPage.change(function () {
            getEmployees('Name', 'asc', 1, $(this).val())
        })


        //Sorts the employees by name
        $('#sortByName').click(function () {
            getEmployees('Name', sortNameDirection, pageNumber, rowsPerPage.val());
            sortNameDirection === 'asc' ? sortNameDirection = 'desc' : sortNameDirection = 'asc';
        })

        //Sorts the employeesby email
        $('#sortByEmail').click(function () {
            getEmployees('Email', sortEmailDirection, pageNumber, rowsPerPage.val());
            sortEmailDirection === 'asc' ? sortEmailDirection = 'desc' : sortEmailDirection = 'asc';
        })


        //Sorts the employeesby salary
        $('#sortBySalary').click(function () {
            getEmployees('Salary', sortSalaryDirection, pageNumber, rowsPerPage.val());
            sortSalaryDirection === 'asc' ? sortSalaryDirection = 'desc' : sortSalaryDirection = 'asc';
        })

        //Fetching the names for the autocomplete
        searchName.autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: '/employees/employeeNames?searchTerm=' + request.term,
                    method: 'get',
                    success: function (data) {
                        response(data);
                    },
                    error: function (error) {
                        console.log(error);
                        $('#dialogError').dialog();
                    }
                })
            },
            // Fetching the employee(s) by the selected name
            close: function () {
                const name = $(this).val();
                $.ajax({
                    url: '/employees/searchByName?name=' + name,
                    method: 'get',
                    success: function (response) {
                        searchName.val('');
                        $('#tblEmployees').find("tr:gt(0)").remove();
                        $.each(response, (ind, val) => {
                            createTable(val.Id, val.Name, val.Email, val.Salary);
                        })
                    }
                })
            }
            //Highlights the selected text using regular expression with case sensitivity
        }).data('ui-autocomplete')._renderItem = function (ul, item) {
            var expression = new RegExp("(" + this.term + ")", 'gi');
            var answer = item.label.replace(expression, "<span style='color:#f00'>$1</span>")


            return $('<li></li>').append('<a>' + answer + '</a>').appendTo(ul);
        }

        //Fetching the emails for the autocomplete
        searchEmail.autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: '/employees/employeeEmails?searchTerm=' + request.term,
                    method: 'get',
                    success: function (data) {
                        response(data);
                    },
                    error: function (error) {
                        console.log(error);
                        $('#dialogError').dialog();
                    }
                })
            },
            // Fetching the employee by the selected email
            close: function () {
                const email = $(this).val();
                $.ajax({
                    url: '/employees/searchByEmail?email=' + email,
                    method: 'get',
                    success: function (response) {
                        searchEmail.val('');
                        $('#tblEmployees').find("tr:gt(0)").remove();
                        $.each(response, (ind, val) => {
                            createTable(val.Id, val.Name, val.Email, val.Salary);
                        })
                    }
                })
            }
            //The following code highlights the selected text using regular expression
        }).data('ui-autocomplete')._renderItem = function (ul, item) {
            var expression = new RegExp("(" + this.term + ")", 'gi');
            var answer = item.label.replace(expression, "<span style='color:#f00'>$1</span>")


            return $('<li></li>').append('<a>' + answer + '</a>').appendTo(ul);
        }

        //Fetching the salaries for the autocomplete
        searchSalary.autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: '/employees/employeeSalaries?searchTerm=' + request.term,
                    method: 'get',
                    success: function (data) {
                        response(data);
                    },
                    error: function (error) {
                        console.log(error);
                        $('#dialogError').dialog();
                    }
                })
            },
            // Fetching the employee(s) by the selected salary
            close: function () {
                const salary = $(this).val();
                $.ajax({
                    url: '/employees/searchBySalary?salary=' + salary,
                    method: 'get',
                    success: function (response) {
                        searchSalary.val('');
                        $('#tblEmployees').find("tr:gt(0)").remove();
                        $.each(response, (ind, val) => {
                            createTable(val.Id, val.Name, val.Email, val.Salary);
                        })
                    }
                })
            }
            //The following code highlights the selected text using regular expression
        }).data('ui-autocomplete')._renderItem = function (ul, item) {
            var expression = new RegExp("(" + this.term + ")", 'gi');
            var answer = item.label.replace(expression, "<span style='color:#f00'>$1</span>")


            return $('<li></li>').append('<a>' + answer + '</a>').appendTo(ul);
        }

        //Triggers the search functionality in case the user chooses not to use the autocomplete and type the whole name pressing enter or tab
        searchName.change(function () {
            const name = $(this).val();
            $.ajax({
                url: '/employees/searchByName?name=' + name,
                method: 'get',
                success: function (response) {
                    $('#tblEmployees').find("tr:gt(0)").remove();
                    searchName.val('');
                    $.each(response, (ind, val) => {
                        createTable(val.Id, val.Name, val.Email, val.Salary);
                    })
                },
                error: function (error) {
                    console.log(error);
                    $('#dialogError').dialog();
                }
            })
        })

        //Triggers the search functionality in case the user chooses not to use the autocomplete and type the whole email pressing enter or tab
        searchEmail.change(function () {
            const email = $(this).val();
            $.ajax({
                url: '/employees/searchByEmail?email=' + email,
                method: 'get',
                success: function (response) {
                    console.log(response);
                    $('#tblEmployees').find("tr:gt(0)").remove();
                    searchEmail.val('');
                    $.each(response, (ind, val) => {
                        createTable(val.Id, val.Name, val.Email, val.Salary);
                    })
                },
                error: function (error) {
                    console.log(error);
                    $('#dialogError').dialog();
                }
            })
        })

        //Triggers the search functionality in case the user chooses not to use the autocomplete and type the whole salary pressing enter or tab
        searchSalary.change(function () {
            const salary = $(this).val();
            $.ajax({
                url: '/employees/searchBySalary?salary=' + salary,
                method: 'get',
                success: function (response) {
                    $('#tblEmployees').find("tr:gt(0)").remove();
                    searchSalary.val('');
                    $.each(response, (ind, val) => {
                        createTable(val.Id, val.Name, val.Email, val.Salary);
                    })
                },
                error: function (error) {
                    console.log(error);
                    $('#dialogError').dialog();
                }
            })
        })
    })


    //Functions-----------------------------------------------------------------------------------------

    // Ajax call to get the total number of employees to use it for pagination
    // The edit and delete buttons are created dynamically with the createTable() function
    // They trigger the respective modal passing the Id through the data-id attribute
    function getEmployees(sortingByWhat, sortDirection, pageNumber, rowsPerPage) {
        const table = $('#tblEmployees')
        let totalRows = 0;
        $.ajax({
            url: '/employees',
            method: 'get',
            success: function (response) {
                totalRows = response.length
            },
            error: function (error) {
                console.log(error);
                $('#dialogError').dialog();
            }
            //We need the total number of rows in order to do the pagination
            //'done()' guarantees that the following code will execute after the completion of the previous ajax call
        }).done(() => {
            $.ajax({
                url: `/employees/sortBy${sortingByWhat}?sort=${sortDirection}&pageNumber=${pageNumber}&numberOfRowsPerPage=${rowsPerPage}`,
                method: 'get',
                success: function (response) {
                    table.find("tr:gt(0)").remove();
                    const numberOfPages = Math.ceil(totalRows / rowsPerPage);
                    $('#paginationUl').empty();
                    for (var i = 0; i < numberOfPages; i++) {
                        $(`<li class="page-item">
                        <button data-page="${i + 1}" data-rows="${rowsPerPage}" data-sortdirection=${sortDirection} data-sortbywhat=${sortingByWhat} onclick="pagination(this)" class="page-link">${i + 1}</button>
                 </li>`).appendTo('#paginationUl');
                        pageNumber = i + 1;
                    }
                    $.each(response, (ind, val) => {
                        createTable(val.Id, val.Name, val.Email, val.Salary.toFixed(2));
                    })
                }
            })
        })
    }

    //function sorting(response) {
    //    $('#tblEmployees').find("tr:gt(0)").remove();
    //    $.each(response, (ind, val) => {
    //        createTable(val.Id, val.Name, val.Email, val.Salary);
    //    })
    //    sortSalaryDirection === 'asc' ? sortSalaryDirection = 'desc' : sortSalaryDirection = 'asc';
    //    sortingByWhat = 'Salary'
    //}

    //Is triggered when a pagination button is clicked and does the pagination
    function pagination(element) {
        const pageNumber = $(element).data('page');
        const numberOfRowsPerPage = $(element).data('rows');
        const sortDirection = $(element).data('sortdirection');
        const sortByWhat = $(element).data('sortbywhat');

        getEmployees(sortByWhat, sortDirection, pageNumber, numberOfRowsPerPage)
    }

    //Finds the employee to be edited and fills the fields of the modal with their respective values
    function editItem(element) {
        //Retrieves the id from the custom data-id attribute
        const id = $(element).data('id');
        $.ajax({
            url: '/employees/' + id,
            method: 'get',
            success: function (response) {
                fillModalInputFields('edit', response)
            },
            error: function (error) {
                console.log(error);
                $('#dialogError').dialog();
            }
        })
    }

    //Finds the employee to be deleted and fills the fields of the modal with their respective values
    function deleteItem(element) {
        //Retrieves the id from the custom data-id attribute
        const id = $(element).data('id');
        $.ajax({
            url: '/employees/' + id,
            method: 'get',
            success: function (response) {
                fillModalInputFields('delete', response)
            },
            error: function (error) {
                console.log(error);
                $('#dialogError').dialog();
            }
        })
    }

    //Shows the details of the specific employee
    function details(element) {
        //Retrieves the id from the custom data-id attribute
        const id = $(element).data('id');
        $.ajax({
            url: '/employees/' + id,
            method: 'get',
            success: function (response) {
                fillModalInputFields('display', response);
            },
            error: function (error) {
                console.log(error);
                $('#dialogError').dialog();
            }
        })

    }

    //Helper Functions
    //--------------------------------------------------------
    //Creates the table after the ajax calls for getting and sorting the employees
    function createTable(id, name, email, salary) {
        $('#tblEmployees').append(`
<tr>
<td>${name}</td>
<td>${email}</td>
<td>${salary}</td>
<td>
<button type="button" onclick="details(this)" class="btn btn-dark" data-toggle="modal" data-target="#employeeDetails" data-id="${id}">Details</button>
</td>
<td>
<button type="button" onclick="editItem(this)" class="btn btn-dark" data-toggle="modal" data-target="#editModal" data-id="${id}">Edit</button>
</td>
<td>
<button type="button" onclick="deleteItem(this)" class="btn btn-danger" data-toggle="modal" data-target="#deleteModal" data-id="${id}">Delete</button>
</td>
</tr>`
        )
    }

    //Fills the modals for editing and deleting an employee
    function fillModalInputFields(value, response) {
        $('#' + value + 'Name').val(response.Name)
        $('#' + value + 'Email').val(response.Email)
        $('#' + value + 'Salary').val(response.Salary)
        $('#' + value + 'Id').val(response.Id)
    }
</script>
