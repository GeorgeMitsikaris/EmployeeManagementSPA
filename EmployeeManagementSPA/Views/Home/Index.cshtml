@{
    ViewBag.Title = "Employee Index";
}

<div class="container mt-3">
    <div class="row">
        <button class="btn btn-primary m-auto" data-toggle="modal" data-target="#insertModal">Create New</button>
    </div>
    <div class="row col-sm-12">
        <div class="text-left display-4 m-auto">Employees</div>
        <table id="tblEmployees" class="table table-striped text-center mt-3">
            <thead>
                <tr class="table-info">
                    <td class="font-weight-bold">
                        <button id="sortByName" class="btn btn-block btn-warning">
                            <p class="pr-3 d-inline">Name</p><span class="fa fa-arrow-up pr-1"></span><span class="fa fa-arrow-down"></span>
                        </button>
                        <div class="input-group-append">
                            <input id="txtSearchName" type="text" class="form-control" placeholder="Search" style="border-bottom-right-radius:0; border-top-right-radius:0" />
                            <button id="searchName" class="fa fa-search btn btn-light"></button>
                        </div>
                    </td>
                    <td class="font-weight-bold">
                        <button id="sortByEmail" class="btn btn-block btn-warning mr-3">
                            <p class="pr-3 d-inline">Email</p><span class="fa fa-arrow-up pr-1"></span><span class="fa fa-arrow-down"></span>
                        </button>
                        <div class="input-group-append">
                            <input id="txtSearchEmail" type="text" class="form-control" placeholder="Search" style="border-bottom-right-radius:0; border-top-right-radius:0" />
                            <button id="searchEmail" class="fa fa-search btn btn-light"></button>
                        </div>
                    </td>
                    <td class="font-weight-bold">
                        <button id="sortBySalary" class="btn btn-block btn-warning mr-3"><p class="pr-3 d-inline">Salary</p><span class="fa fa-arrow-up pr-1"></span><span class="fa fa-arrow-down"></span></button>
                        <div class="input-group-append">
                            <input id="txtSearchSalary" type="text" class="form-control" placeholder="Search" style="border-bottom-right-radius:0; border-top-right-radius:0" />
                            <button id="searchSalary" class="fa fa-search btn btn-light"></button>
                        </div>
                    </td>
                    <td colspan="2" class="font-weight-bold">Actions</td>
                </tr>
            </thead>
            <tbody id="tblBody"></tbody>
        </table>
    </div>
</div>

<div id="insertModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add New Employee</div>
                <button class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form>
                    <input type="hidden" id="employeeId" />
                    <div class="form-group">
                        <label for="name">Name</label>
                        <input type="text" id="name" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="salary">Salary</label>
                        <input type="text" id="salary" class="form-control" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="btnInsert" class="btn btn-info" data-dismiss="modal">Create</button>
            </div>
        </div>
    </div>
</div>

<div id="editModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Edit Item Type</div>
                <button class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form>
                    <input id="idToEdit" type="hidden" />
                    <div class="form-group">
                        <label for="name">Name</label>
                        <input type="text" id="editName" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="editEmail" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="salary">Salary</label>
                        <input type="text" id="editSalary" class="form-control" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="btnEditItem" class="btn btn-info" data-dismiss="modal">Save</button>
            </div>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Are you sure you want to delete this Item Type?</div>
                <button class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form>
                    <input id="idToDelete" type="hidden" />
                    <div class="form-group">
                        <label for="name">Name</label>
                        <input type="text" id="deleteName" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="deleteEmail" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="salary">Salary</label>
                        <input type="text" id="deleteSalary" class="form-control" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="btnDeleteItem" class="btn btn-info" data-dismiss="modal">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {

        //Call the function getEmployees() which is declared below using hoisting
        getEmployees();

        //Ajax call to create a new employee
        $('#btnInsert').click(function () {
            const Name = $('#name').val();
            const Email = $('#email').val();
            const Salary = $('#salary').val();
            $.ajax({
                url: '/employees',
                method: 'post',
                //Using concise ES6 syntax
                data: { Name, Email, Salary },
                success: function () {
                    table.append(`
                        <tr>
                            <td>${Name}</td>
                            <td>${Email}</td>
                            <td>${Salary}</td>
                        </tr>`
                    )
                },
                error: function (error) {
                    console.log(error);
                }
            })
        })

        //Ajax call to update the Employee details
        $('#btnEditItem').click(function () {
            const id = $('#idToEdit').val();
            const Name = $('#editName').val();
            const Email = $('#editEmail').val();
            const Salary = $('#editSalary').val();

            $.ajax({
                url: '/employees/' + id,
                method: 'put',
                //Using concise ES6 syntax
                data: { Name, Email, Salary },
                success: function () {
                    getEmployees();
                },
                error: (err) => {
                    console.log(err);
                }
            })
        })

        //Ajax call to delete the Employee
        $('#btnDeleteItem').click(function () {
            const id = $('#idToDelete').val();
            console.log(id);
            $.ajax({
                url: '/employees/' + id,
                method: 'delete',
                success: function () {
                    getEmployees();
                },
                error: (err) => {
                    console.log(err);
                }
            })
        })

        //Declaration of the sorting variables
        let sortName = 'asc';


        //Ajax call to sort by name
        $('#sortByName').click(function () {
            $.ajax({
                url: `/employees/sortByName?sort=${sortName}`,
                method: 'get',
                success: function (response) {
                    $('#tblEmployees').find("tr:gt(0)").remove();
                    $.each(response, (ind, val) => {
                        $('#tblEmployees').append(`
                            <tr>
                                <td>${val.Name}</td>
                                <td>${val.Email}</td>
                                <td>${val.Salary}</td>
                                <td>
                                    <button type="button" onclick="editItem(this)" class="btn btn-dark" data-toggle="modal" data-target="#editModal" data-id="${val.Id}">Edit</button>
                                </td>
                                <td>
                                    <button type="button" onclick="deleteItem(this)" class="btn btn-danger" data-toggle="modal" data-target="#deleteModal" data-id="${val.Id}">Delete</button>
                                </td>
                            </tr>`
                        )
                    })
                    if (sortName === 'asc')
                        sortName = 'desc';
                    else
                        sortName = 'asc';
                },
                error: function (error) {
                    console.log(error);
                }
            })
        })
    })


    //Functions

    // Ajax call to get all employees
    // The edit and delete buttons are created dynamically
    // They trigger the respective modal passing the Id through the data-id attribute
    function getEmployees() {
        const table = $('#tblEmployees')

        $.ajax({
            url: '/employees',
            method: 'get',
            success: function (response) {
                table.find("tr:gt(0)").remove();
                $.each(response, (ind, val) => {
                    $('#tblEmployees').append(`
                            <tr>
                                <td>${val.Name}</td>
                                <td>${val.Email}</td>
                                <td>${val.Salary}</td>
                                <td>
                                    <button type="button" onclick="editItem(this)" class="btn btn-dark" data-toggle="modal" data-target="#editModal" data-id="${val.Id}">Edit</button>
                                </td>
                                <td>
                                    <button type="button" onclick="deleteItem(this)" class="btn btn-danger" data-toggle="modal" data-target="#deleteModal" data-id="${val.Id}">Delete</button>
                                </td>
                            </tr>`
                    )
                })
            }
        })
    }

    //This function finds the employee to be edited and fills the fields of the modal with their respective values
    function editItem(element) {
        //Retrieves the id from the custom data-id attribute
        const id = $(element).data('id');
        $.ajax({
            url: '/employees/' + id,
            method: 'get',
            success: function (response) {
                $('#editName').val(response.Name)
                $('#editEmail').val(response.Email)
                $('#editSalary').val(response.Salary)
                $('#idToEdit').val(response.Id)
            },
            error: function (error) {
                console.log(error);
            }
        })
    }

    //This function finds the employee to be deleted and fills the fields of the modal with their respective values
    function deleteItem(element) {
        //Retrieves the id from the custom data-id attribute
        const id = $(element).data('id');
        $.ajax({
            url: '/employees/' + id,
            method: 'get',
            success: function (response) {
                $('#deleteName').val(response.Name)
                $('#deleteEmail').val(response.Email)
                $('#deleteSalary').val(response.Salary)
                $('#idToDelete').val(response.Id)
            },
            error: function (error) {
                console.log(error);
            }
        })
    }
</script>
